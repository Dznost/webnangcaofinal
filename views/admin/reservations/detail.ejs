<section class="admin-section">
    <div class="container">
        <div class="section-header">
            <h1>ü™ë Chi Ti·∫øt ƒê·∫∑t B√†n #<%= reservation._id.toString().slice(-6) %></h1>
            <a href="/admin/reservations" class="btn btn-secondary">‚Üê Quay L·∫°i</a>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Th√¥ng Tin Kh√°ch H√†ng</h3>
                <p><strong>Email:</strong> <%= reservation.user?.email || 'N/A' %></p>
                <p><strong>T√™n:</strong> <%= reservation.user?.name || 'N/A' %></p>
                <p><strong>SƒêT:</strong> <%= reservation.user?.phone || reservation.phone || 'N/A' %></p>
            </div>

            <div class="detail-card">
                <h3>Th√¥ng Tin ƒê·∫∑t B√†n</h3>
                <p><strong>Chi Nh√°nh:</strong> <%= reservation.branch?.name || 'N/A' %></p>
                <p><strong>ƒê·ªãa ch·ªâ:</strong> <%= reservation.branch?.address || 'N/A' %></p>
                <p><strong>Ng√†y:</strong> <%= new Date(reservation.reservationDate).toLocaleDateString('vi-VN') %></p>
                <p><strong>Gi·ªù:</strong> <%= reservation.reservationTime %></p>
                <p><strong>S·ªë Kh√°ch:</strong> <%= reservation.numberOfGuests %> ng∆∞·ªùi</p>
                <p><strong>Ph√≠ ƒë·∫∑t c·ªçc:</strong> <%= reservation.depositAmount?.toLocaleString('vi-VN') || 0 %> ƒë</p>
            </div>
        </div>

        <% if (reservation.orderItems && reservation.orderItems.length > 0) { %>
        <div class="detail-card">
            <h3>üçΩÔ∏è M√≥n ƒÇn ƒê·∫∑t Tr∆∞·ªõc</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>T√™n M√≥n</th>
                        <th>S·ªë L∆∞·ª£ng</th>
                        <th>Gi√°</th>
                        <th>Th√†nh Ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    <% reservation.orderItems.forEach(item => { %>
                    <tr>
                        <td><%= item.dish?.name || 'N/A' %></td>
                        <td><%= item.quantity %></td>
                        <td><%= item.price?.toLocaleString('vi-VN') %> ƒë</td>
                        <td><%= (item.quantity * item.price)?.toLocaleString('vi-VN') %> ƒë</td>
                    </tr>
                    <% }) %>
                    <tr>
                        <td colspan="3" style="text-align: right;"><strong>T·ªïng ti·ªÅn m√≥n ƒÉn:</strong></td>
                        <td><strong><%= reservation.totalAmount?.toLocaleString('vi-VN') %> ƒë</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <% } %>

        <div class="detail-card">
            <h3>Y√™u C·∫ßu ƒê·∫∑c Bi·ªát</h3>
            <p><%= reservation.specialRequests || 'Kh√¥ng c√≥' %></p>
        </div>

        <% if (payment) { %>
        <div class="detail-card">
            <h3>üí≥ Th√¥ng Tin Thanh To√°n</h3>
            <p><strong>M√£ GD:</strong> <%= payment.transactionId || 'N/A' %></p>
            <p><strong>T·ªïng thanh to√°n:</strong> <%= payment.amount?.toLocaleString('vi-VN') %> ƒë</p>
            <p><strong>Ph∆∞∆°ng th·ª©c:</strong> 
                <%= payment.paymentMethod === 'bank' ? 'üè¶ Chuy·ªÉn kho·∫£n ng√¢n h√†ng' : 'üì± MoMo' %>
            </p>
            <p><strong>Tr·∫°ng th√°i:</strong> 
                <span class="status-badge status-<%= payment.status %>">
                    <%= payment.status === 'completed' ? '‚úÖ ƒê√£ thanh to√°n' : '‚è≥ Ch·ªù x√°c nh·∫≠n' %>
                </span>
            </p>
            <p><strong>Thanh to√°n l√∫c:</strong> <%= payment.paidAt ? new Date(payment.paidAt).toLocaleString('vi-VN') : 'N/A' %></p>
        </div>
        <% } %>

        <div class="detail-card">
            <h3>C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i</h3>
            <!-- Fixed form action URL from /admin/reservation/ to /admin/reservations/ -->
            <form method="POST" action="/admin/reservations/<%= reservation._id %>/status" class="status-form">
                <select name="status" required>
                    <option value="pending" <%= reservation.status === 'pending' ? 'selected' : '' %>>Ch·ªù X√°c Nh·∫≠n</option>
                    <option value="confirmed" <%= reservation.status === 'confirmed' ? 'selected' : '' %>>ƒê√£ X√°c Nh·∫≠n</option>
                    <option value="cancelled" <%= reservation.status === 'cancelled' ? 'selected' : '' %>>H·ªßy</option>
                </select>
                <button type="submit" class="btn btn-primary">C·∫≠p Nh·∫≠t</button>
            </form>
        </div>
    </div>
</section>
