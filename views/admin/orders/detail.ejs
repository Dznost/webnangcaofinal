<section class="admin-section">
    <div class="container">
        <div class="section-header">
            <h1>üì¶ Chi Ti·∫øt ƒê∆°n H√†ng #<%= order._id.toString().slice(-6) %></h1>
            <a href="/admin/orders" class="btn btn-secondary">‚Üê Quay L·∫°i</a>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <h3>Th√¥ng Tin Kh√°ch H√†ng</h3>
                <p><strong>Email:</strong> <%= order.user?.email || order.email || 'N/A' %></p>
                <p><strong>T√™n:</strong> <%= order.user?.name || order.fullName || 'N/A' %></p>
                <p><strong>SƒêT:</strong> <%= order.user?.phone || order.phone || 'N/A' %></p>
            </div>

            <div class="detail-card">
                <h3>Th√¥ng Tin ƒê∆°n H√†ng</h3>
                <p><strong>Lo·∫°i:</strong> <%= order.orderType === 'dine-in' ? 'üçΩÔ∏è ƒÇn t·∫°i qu√°n' : 'üè† Mang v·ªÅ' %></p>
                <% if (order.branchId) { %>
                    <p><strong>Chi nh√°nh:</strong> <%= order.branchId.name || 'N/A' %></p>
                <% } %>
                <p><strong>T·ªïng Ti·ªÅn:</strong> <%= order.totalPrice?.toLocaleString('vi-VN') || 0 %> ƒë</p>
                <% if (order.discount > 0) { %>
                    <p><strong>Gi·∫£m gi√°:</strong> <span style="color: #28a745;"><%= order.discount?.toLocaleString('vi-VN') %> ƒë</span></p>
                    <p><strong>Th√†nh ti·ªÅn:</strong> <strong><%= order.finalPrice?.toLocaleString('vi-VN') %> ƒë</strong></p>
                <% } %>
                <p><strong>ƒê·ªãa Ch·ªâ Giao:</strong> <%= order.deliveryAddress || 'N/A' %></p>
                <p><strong>Ph∆∞∆°ng th·ª©c TT:</strong> <%= order.paymentMethod === 'bank' ? 'üè¶ Ng√¢n h√†ng' : (order.paymentMethod === 'momo' ? 'üì± MoMo' : 'üíµ COD') %></p>
                <p><strong>Tr·∫°ng th√°i TT:</strong> 
                    <span class="status-badge <%= order.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid' %>">
                        <%= order.paymentStatus === 'paid' ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n' %>
                    </span>
                </p>
                <p><strong>Ng√†y T·∫°o:</strong> <%= new Date(order.createdAt).toLocaleDateString('vi-VN') %></p>
            </div>
        </div>

        <div class="detail-card">
            <h3>C√°c M√≥n ƒÇn</h3>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>T√™n M√≥n</th>
                        <th>S·ªë L∆∞·ª£ng</th>
                        <th>Gi√°</th>
                        <th>Gi·∫£m Gi√°</th>
                        <th>T·ªïng</th>
                    </tr>
                </thead>
                <tbody>
                    <% order.items?.forEach(item => { %>
                    <tr>
                        <td><%= item.dishId?.name || item.name || 'N/A' %></td>
                        <td><%= item.quantity %></td>
                        <td><%= item.price?.toLocaleString('vi-VN') %> ƒë</td>
                        <td><%= item.discount ? (item.discount + '%') : '0%' %></td>
                        <td><%= ((item.quantity * item.price * (1 - (item.discount || 0) / 100)))?.toLocaleString('vi-VN') %> ƒë</td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>

        <% if (payment) { %>
        <div class="detail-card">
            <h3>üí≥ Th√¥ng Tin Thanh To√°n</h3>
            <p><strong>M√£ GD:</strong> <%= payment.transactionId || 'N/A' %></p>
            <p><strong>S·ªë ti·ªÅn:</strong> <%= payment.amount?.toLocaleString('vi-VN') %> ƒë</p>
            <p><strong>Tr·∫°ng th√°i:</strong> 
                <span class="status-badge status-<%= payment.status %>">
                    <%= payment.status === 'completed' ? '‚úÖ Ho√†n th√†nh' : payment.status === 'pending' ? '‚è≥ Ch·ªù x·ª≠ l√Ω' : '‚ùå Th·∫•t b·∫°i' %>
                </span>
            </p>
            <p><strong>Thanh to√°n l√∫c:</strong> <%= payment.paidAt ? new Date(payment.paidAt).toLocaleString('vi-VN') : 'N/A' %></p>
        </div>
        <% } %>

        <div class="detail-card">
            <h3>C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i</h3>
            <!-- Fixed form action URL from /admin/order/ to /admin/orders/ -->
            <form method="POST" action="/admin/orders/<%= order._id %>/status" class="status-form">
                <select name="status" required>
                    <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Ch·ªù X·ª≠ L√Ω</option>
                    <option value="completed" <%= order.status === 'completed' ? 'selected' : '' %>>Ho√†n Th√†nh</option>
                    <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>H·ªßy</option>
                </select>
                <button type="submit" class="btn btn-primary">C·∫≠p Nh·∫≠t</button>
            </form>
        </div>
    </div>
</section>
